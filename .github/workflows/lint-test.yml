name: Lint & Test

on:
    push:
        branches:
            - "feature/*"
            - "fix/*"
            - "optimize/*"
    pull_request:
        branches:
            - develop

jobs:
    lint-and-test:
        runs-on: ubuntu-latest

        steps:
            # Checkout kode dari PR
            - name: Checkout repository
              uses: actions/checkout@v4

            # Setup Java (dibutuhkan Flutter untuk build Android)
            - name: Setup Java
              uses: actions/setup-java@v4
              with:
                  distribution: "temurin"
                  java-version: "17"

            # Setup Flutter
            - name: Setup Flutter
              uses: subosito/flutter-action@v2
              with:
                  flutter-version: "3.35.1"
                  channel: "stable"
                  cache: true

            # Ambil dependencies
            - name: Get dependencies
              run: flutter pub get

            # Langkah kunci: Membuat file .env dari secret JSON
            # Runner 'ubuntu-latest' sudah memiliki jq terinstal secara default.
            - name: Generate .env
              run: |
                  echo "${{ secrets.ENV_VARS_DEV }}" | jq -r 'to_entries|map("\(.key)=\(.value|tostring)")|.[]' > .env.development
                  echo "${{ secrets.ENV_VARS_STAGE }}" | jq -r 'to_entries|map("\(.key)=\(.value|tostring)")|.[]' > .env.staging
                  echo "${{ secrets.ENV_VARS_PROD }}" | jq -r 'to_entries|map("\(.key)=\(.value|tostring)")|.[]' > .env.production

            # Lint (analyze)
            - name: Run flutter analyze
              run: flutter analyze

            # Test
            - name: Run flutter test
              run: flutter test
